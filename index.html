<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Chat Uygulamasƒ± (Nihai Versiyon)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f7f6; display: flex; justify-content: center; padding-top: 20px; }
        #chat-container { width: 100%; max-width: 600px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; display: flex; flex-direction: column; height: 90vh; }
        
        /* Auth Panel Stili */
        #auth-panel { padding: 15px; border-bottom: 1px solid #ddd; background: #f8f8f8; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;}
        #auth-panel input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #auth-panel button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        #login-button { background-color: #007bff; }
        #logout-button { background-color: #dc3545; }
        
        /* Admin Toplu Silme Butonu Stili */
        #deleteAllBtn {
            background-color: #dc3545; 
            color: white;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Mesaj Listesi Stili */
        #mesaj-listesi { flex-grow: 1; padding: 20px; overflow-y: auto; list-style: none; margin: 0; }
        #mesaj-listesi li { 
            background: #e6e6e6; 
            padding: 10px 15px; 
            border-radius: 20px; 
            margin-bottom: 10px; 
            max-width: 80%; 
            position: relative; 
            padding-bottom: 35px; 
        }
        .mesaj-baslik { display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 5px; }
        .gonderen { font-weight: bold; color: #007bff; }
        .zaman { color: #6c757d; }
        
        /* Form Stili */
        #gonder-formu { 
            display: none; 
            padding: 15px; 
            border-top: 1px solid #ddd; 
            background: #fff; 
            gap: 10px; 
        }
        #mesaj-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
        #gonder-formu button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 20px; cursor: pointer; }
        
        /* Buton Konumlarƒ± */
        .copy-btn, .edit-btn, .delete-btn {
            position: absolute;
            bottom: 5px; 
            padding: 4px 8px; 
            font-size: 0.7em; 
            border-radius: 10px; 
            cursor: pointer; 
            opacity: 0.8;
            border: none;
        }

        .copy-btn { 
            left: 5px; 
            background-color: #00bcd4; 
            color: white; 
        }
        .edit-btn { 
            left: 75px; 
            background-color: #ffcc00; 
            color: #333; 
        }
        .delete-btn { 
            right: 5px; 
            background-color: #ffc107; 
            color: #333; 
        }
        .admin-btn { 
            background-color: #dc3545; 
            color: white; 
        }
    </style>
</head>
<body>

    <div id="chat-container">
        
        <div id="auth-panel">
            <div id="kullanici-durumu">Oturum A√ßƒ±lmadƒ±.</div>
            <div>
                <button id="deleteAllBtn" style="display: none;">üóëÔ∏è T√ºm√ºn√º Sil</button>

                <input type="text" id="nickname-input" placeholder="Takma Ad">
                <input type="password" id="sifre-input" placeholder="≈ûifre">
                <button id="login-button">Giri≈ü Yap</button>
                <button id="logout-button" style="display: none;">√áƒ±kƒ±≈ü Yap</button>
            </div>
        </div>
        
        <ul id="mesaj-listesi">
            </ul>
        
        <form id="gonder-formu">
            <input type="text" id="mesaj-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." required>
            <button type="submit">G√∂nder</button>
        </form>

    </div>
    
    <script type="module">
        // Firebase SDK mod√ºllerini import edin.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        // Sorgu fonksiyonlarƒ± (where, limit) eklendi
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, writeBatch, getDocs, updateDoc, where, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // =========================================================
        // Firebase Config Objesi (Kendi projenizden kopyalayƒ±n)
        // =========================================================
        const firebaseConfig = {
          apiKey: "AIzaSy...", 
          authDomain: "proje-id.firebaseapp.com", 
          projectId: "proje-id", 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeUser = null; 
        
        // ZAMAN A≈ûIMI DEƒûƒ∞≈ûKENLERƒ∞
        let isCooldownActive = false;
        const COOLDOWN_SECONDS = 5; 

        // HTML Elemanlarƒ± Tanƒ±mlamalarƒ±
        const mesajListesi = document.getElementById('mesaj-listesi');
        const gonderFormu = document.getElementById('gonder-formu');
        const mesajInput = document.getElementById('mesaj-input');
        const submitButton = gonderFormu.querySelector('button[type="submit"]');

        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const nicknameInput = document.getElementById('nickname-input');
        const sifreInput = document.getElementById('sifre-input');
        const kullaniciDurumu = document.getElementById('kullanici-durumu');
        const deleteAllBtn = document.getElementById('deleteAllBtn'); 


        // =========================================================
        // YETKƒ∞LENDƒ∞RME ve ARABƒ∞Rƒ∞M Y√ñNETƒ∞Mƒ∞
        // =========================================================

        function updateUI() {
            const isAdmin = activeUser && activeUser.rol === 'admin';

            if (activeUser) {
                kullaniciDurumu.textContent = `Ho≈ü geldiniz, ${activeUser.nickname} (${activeUser.rol})`;
                loginButton.style.display = 'none';
                logoutButton.style.display = 'inline-block';
                nicknameInput.style.display = 'none';
                sifreInput.style.display = 'none';
                gonderFormu.style.display = 'flex'; 
                
                // Admin butonu sadece Admin giri≈ü yaptƒ±ysa g√∂r√ºn√ºr.
                deleteAllBtn.style.display = isAdmin ? 'inline-block' : 'none';

            } else {
                kullaniciDurumu.textContent = `Oturum A√ßƒ±lmadƒ± (Sadece Okuma)`;
                loginButton.style.display = 'inline-block';
                logoutButton.style.display = 'none';
                nicknameInput.style.display = 'inline-block'; 
                sifreInput.style.display = 'inline-block'; 
                gonderFormu.style.display = 'none';
                deleteAllBtn.style.display = 'none'; 
            }
        }

        // Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMƒ∞ (SHA-256 ile Firestore'dan kontrol)
        loginButton.addEventListener('click', async () => {
            const nickname = nicknameInput.value.trim();
            const sifre = sifreInput.value.trim();

            if (nickname === "" || sifre === "") {
                alert("Takma ad ve ≈üifre alanlarƒ± bo≈ü bƒ±rakƒ±lamaz.");
                return;
            }
            
            // 1. Girilen ≈üifreyi SHA-256 ile hashele (sha256 global scope'ta tanƒ±mlƒ±dƒ±r)
            const girilenSifreHash = sha256(sifre);
            
            // 2. Kullanƒ±cƒ±yƒ± Firestore'dan nickname'e g√∂re √ßek
            try {
                const usersRef = collection(db, "kullanicilar");
                const q = query(usersRef, where("nickname", "==", nickname), limit(1));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    alert("Hatalƒ± Takma Ad veya ≈ûifre.");
                    activeUser = null;
                    return;
                }

                const userData = snapshot.docs[0].data();

                // 3. Hashleri kar≈üƒ±la≈ütƒ±r
                if (userData.sifreHash === girilenSifreHash) {
                    // BA≈ûARILI Gƒ∞Rƒ∞≈û
                    activeUser = {
                        nickname: userData.nickname,
                        rol: userData.rol,
                        uid: userData.uid
                    };

                    updateUI();
                    nicknameInput.value = '';
                    sifreInput.value = '';
                    alert(`Giri≈ü Ba≈üarƒ±lƒ±: ${activeUser.nickname}`);

                } else {
                    // ≈ûifreler E≈üle≈ümedi
                    alert("Hatalƒ± Takma Ad veya ≈ûifre.");
                    activeUser = null;
                }

            } catch (e) {
                console.error("Giri≈ü sƒ±rasƒ±nda hata olu≈ütu: ", e);
                alert("Giri≈ü i≈ülemi sƒ±rasƒ±nda bir sorun olu≈ütu.");
            }
        });

        // √áƒ±kƒ±≈ü i≈ülemi
        logoutButton.addEventListener('click', () => {
            activeUser = null;
            updateUI();
        });


        // =========================================================
        // MESAJ D√úZENLEME FONKSƒ∞YONU
        // =========================================================

        async function handleEdit(docId, currentContent) {
            if (!activeUser) return;

            const newContent = prompt("Mesajƒ± d√ºzenleyin:", currentContent);

            if (newContent !== null && newContent.trim() !== "") {
                const docRef = doc(db, "mesajlar", docId);
                
                try {
                    await updateDoc(docRef, {
                        icerik: newContent.trim(),
                        duzenlemeTarihi: serverTimestamp() 
                    });
                } catch (e) {
                    console.error("Mesaj d√ºzenlenirken hata olu≈ütu: ", e);
                    alert("Mesaj g√ºncellenemedi.");
                }
            }
        }


        // Adminin T√ºm Mesajlarƒ± Silme Fonksiyonu (Yalnƒ±zca butona basƒ±lƒ±nca √ßalƒ±≈üƒ±r)
        async function deleteAllMessages() {
            if (!activeUser || activeUser.rol !== 'admin') {
                alert("Bu i≈ülemi yapmak i√ßin y√∂netici yetkiniz yok.");
                return;
            }

            if (!confirm("UYARI: T√ºm mesajlarƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz.")) {
                return;
            }

            const qAll = query(collection(db, "mesajlar"));
            const snapshot = await getDocs(qAll); 
            const batch = writeBatch(db); 

            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });

            try {
                await batch.commit();
                alert(`Ba≈üarƒ±yla ${snapshot.docs.length} adet mesaj silindi!`);
            } catch (e) {
                console.error("Toplu silme hatasƒ±: ", e);
                alert("Toplu silme i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu. Konsolu kontrol edin.");
            }
        }
        // FONKSƒ∞YON SADECE BURADA EVENT LISTENER ƒ∞LE √áAƒûRILIR!
        deleteAllBtn.addEventListener('click', deleteAllMessages);


        // =========================================================
        // MESAJ G√ñNDERME ƒ∞≈ûLEVƒ∞ (Cooldown ve Bo≈üluk Kontrol√º ile)
        // =========================================================
        gonderFormu.addEventListener('submit', async (e) => {
            e.preventDefault();
            const icerik = mesajInput.value.trim();

            if (!activeUser) return;
            
            // BO≈û MESAJ KONTROL√ú
            if (icerik === "") {
                alert("Bo≈ü mesaj g√∂nderilemez.");
                mesajInput.value = ''; 
                return; 
            }
            
            // ZAMAN A≈ûIMI KONTROL√ú
            if (isCooldownActive) {
                alert(`L√ºtfen ${COOLDOWN_SECONDS} saniye bekleyin.`);
                return;
            }
            
            try {
                // ZAMAN A≈ûIMINI BA≈ûLAT
                isCooldownActive = true;
                submitButton.disabled = true; 
                
                let counter = COOLDOWN_SECONDS;
                submitButton.textContent = `${counter}s`;

                const interval = setInterval(() => {
                    counter--;
                    submitButton.textContent = `${counter}s`;
                    if (counter <= 0) {
                        clearInterval(interval);
                        submitButton.textContent = 'G√∂nder';
                        submitButton.disabled = false;
                        isCooldownActive = false;
                    }
                }, 1000);

                await addDoc(collection(db, "mesajlar"), {
                    gonderen: activeUser.nickname,
                    icerik: icerik,
                    tarih: serverTimestamp(),
                    kullaniciId: activeUser.uid 
                });
                mesajInput.value = '';
                
            } catch (e) {
                isCooldownActive = false; 
                submitButton.textContent = 'G√∂nder';
                submitButton.disabled = false;
                console.error("Mesaj g√∂nderilirken hata olu≈ütu: ", e);
            }
        });


        // =========================================================
        // MESAJLARI GER√áEK ZAMANLI OKUMA VE BUTONLARIN Y√ñNETƒ∞Mƒ∞
        // (T√ºm eski mesajlar artƒ±k y√ºklenir)
        // =========================================================

        const q = query(collection(db, "mesajlar"), orderBy("tarih", "asc"));

        // onSnapshot t√ºm eski (mevcut) mesajlarƒ± "added" t√ºr√ºnde y√ºkler
        onSnapshot(q, (snapshot) => {
            
            snapshot.docChanges().forEach((change) => {
                
                const docId = change.doc.id; 
                
                // Mesaj eklenmesi (yeni mesaj veya ilk y√ºklenen eski mesaj)
                if (change.type === "added") {
                    const data = change.doc.data();
                    
                    let zaman = data.tarih ? new Date(data.tarih.seconds * 1000).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : "≈ûimdi";

                    const li = document.createElement('li');
                    li.setAttribute('data-doc-id', docId); 
                    
                    li.innerHTML = `
                        <div class="mesaj-baslik">
                            <span class="gonderen">${data.gonderen}</span>
                            <span class="zaman">${zaman}</span>
                        </div>
                        <p class="icerik">${data.icerik}</p>
                    `;
                    
                    // 1. KOPYALA BUTONU 
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Kopyala';
                    copyBtn.className = 'copy-btn';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(data.icerik)
                            .then(() => {
                                copyBtn.textContent = 'Kopyalandƒ±!';
                                setTimeout(() => { copyBtn.textContent = 'Kopyala'; }, 1000);
                            });
                    };
                    li.appendChild(copyBtn);

                    // 2. D√úZENLEME VE Sƒ∞LME BUTONLARI (Giri≈ü yapƒ±lmƒ±≈üsa g√∂sterilir)
                    if (activeUser) {
                        const isAdmin = activeUser.rol === 'admin';
                        const isOwner = data.kullaniciId === activeUser.uid;
                        
                        const hasPermission = isAdmin || isOwner; 

                        if (hasPermission) {
                            // D√úZENLE BUTONU
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'D√ºzenle';
                            editBtn.className = 'edit-btn';
                            editBtn.onclick = () => {
                                handleEdit(docId, data.icerik); 
                            };
                            li.appendChild(editBtn);

                            // Sƒ∞L BUTONU
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = isAdmin ? 'Admin Sil' : 'Sil';
                            deleteBtn.className = isAdmin ? 'delete-btn admin-btn' : 'delete-btn';
                            
                            deleteBtn.onclick = () => {
                                deleteDoc(doc(db, "mesajlar", docId));
                            };
                            li.appendChild(deleteBtn);
                        }
                    }

                    mesajListesi.appendChild(li);
                    
                }
                
                // Silme i≈ülemi
                if (change.type === "removed") {
                    const elementToRemove = document.querySelector(`li[data-doc-id="${docId}"]`);
                    if (elementToRemove) {
                        elementToRemove.remove();
                    }
                }
                
                // G√ºncelleme i≈ülemi (D√ºzenleme)
                if (change.type === "modified") {
                    const elementToModify = document.querySelector(`li[data-doc-id="${docId}"]`);
                    if (elementToModify) {
                        const data = change.doc.data();
                        elementToModify.querySelector('.icerik').textContent = data.icerik;
                    }
                }
            });
            
            // T√ºm deƒüi≈üiklikler i≈ülendikten sonra scroll'u en alta √ßek
            mesajListesi.scrollTop = mesajListesi.scrollHeight;
        });
        
        // Sayfa y√ºklendiƒüinde aray√ºz√º ba≈ülat
        updateUI();
        
    </script>

</body>
</html>
